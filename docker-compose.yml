version: "3.9"

services:
  # ═══════════════════════════════════════════════════════════
  # INIT-DB: Import GTFS and pre-calculate schedule positions
  # Only runs on first startup (skips if data exists)
  # ═══════════════════════════════════════════════════════════
  init-db:
    build:
      context: .
      dockerfile: apps/poller/Dockerfile
    volumes:
      - transit_data:/data
      - ./data/gtfs:/data/gtfs:ro
    environment:
      SQLITE_DATABASE: /data/transit.db
      GTFS_DIR: /data/gtfs
    command: ["sh", "/app/init-db.sh"]
    networks:
      - app_network
    restart: "no"

  # ═══════════════════════════════════════════════════════════
  # POLLER: Static data refresh + Real-time polling (Go)
  # Handles Rodalies (GTFS-RT) and Metro (iMetro API) polling
  # Auto-deletes data older than 1 hour
  # ═══════════════════════════════════════════════════════════
  poller:
    build:
      context: .
      dockerfile: apps/poller/Dockerfile
    environment:
      # Database
      SQLITE_DATABASE: /data/transit.db
      # Real-time polling
      POLL_INTERVAL: "30"
      RETENTION_HOURS: "1"
      # Static data refresh (7 days)
      STATIC_REFRESH_DAYS: "7"
      WEB_PUBLIC_DIR: /app/web_public
      CACHE_DIR: /data/cache
      # Rodalies (real-time + static)
      GTFS_VEHICLE_POSITIONS_URL: https://gtfsrt.renfe.com/vehicle_positions.pb
      GTFS_TRIP_UPDATES_URL: https://gtfsrt.renfe.com/trip_updates.pb
      RENFE_GTFS_URL: https://ssl.renfe.com/ftransit/Fichero_CER_FOMENTO/fomento_transit.zip
      # Metro/TMB
      TMB_APP_ID: ${TMB_APP_ID}
      TMB_APP_KEY: ${TMB_APP_KEY}
      TMB_GTFS_URL: https://api.tmb.cat/v1/static/datasets/gtfs.zip
      STATIONS_GEOJSON: /app/web_public/tmb_data/metro/stations.geojson
      LINES_DIR: /app/web_public/tmb_data/metro/lines
    volumes:
      - transit_data:/data
      - ./apps/web/public:/app/web_public
    networks:
      - app_network
    depends_on:
      init-db:
        condition: service_completed_successfully
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════
  # API: Go backend serving SQLite data
  # ═══════════════════════════════════════════════════════════
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile.dev
    command: air
    volumes:
      - ./apps/api:/app
      - aircache:/root/.cache
      - transit_data:/data:ro
    environment:
      - PORT=8080
      - SQLITE_DATABASE=/data/transit.db
    ports:
      - "8080:8080"
    networks:
      - app_network
    depends_on:
      init-db:
        condition: service_completed_successfully
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════
  # WEB: Frontend (reads GeoJSON written by poller)
  # ═══════════════════════════════════════════════════════════
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile.dev
    command: npm run dev -- --host --port 5173
    volumes:
      - ./apps/web:/app
      - webnode:/app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - VITE_API_PROXY_TARGET=http://api:8080
    ports:
      - "5173:5173"
    depends_on:
      - api
    networks:
      - app_network
    restart: unless-stopped
volumes:
  aircache:
  webnode:
  transit_data:

networks:
  app_network:
    driver: bridge
